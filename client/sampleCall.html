<!DOCTYPE html>
<html lang="en">
<head>
  <title>Ethereum: get ether with bitcoin</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/dapp.css">
  <script src="./js/jquery-2.1.3.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>

  <script src="./js/btcRelayAbi.js"></script>

  <script src="./js/bignumber.js"></script>
  <script src="./js/web3.min.js"></script>

  <script src="./js/btcproof.js"></script>

<script type="text/javascript">
var web3 = require('web3');
    web3.setProvider(new web3.providers.HttpProvider('http://localhost:8549'));

var btcproof = require('btcproof');

var gRelayAddr = '0x61f836ebad27a6a3cbb5c070ca6b99925eabd9a3';
var gFromAccount = '0xcd2a3d9f938e13cd947ec05abc7fe734df8dd826';


// CPP apparently can call watch() multiple times and doesn't protect against duplicates
web3.eth.filter({'address': gRelayAddr}).watch(function(err, res) {
  if (err) {
    console.log('@@@ ERROR gRelayAddr filter: ', err)
    return;
  }
  console.log('@@@ gRelayAddr filter')
  console.log(res)

  var logDataFromRelay = res.data;

  // if (web3.toDecimal(logDataFromRelay) === -9999) {
  if (logDataFromRelay === '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd8f1') {
    document.getElementById('result').innerText = 'Bitcoin Transaction not accepted.  Wait for more confirmations or send your Bitcoins again.';
  }
});



var gMerkleProof;
var gBlockHashOfTx;
var gRawTx;
function callContract() {
  console.log('@@@ in callContract')
  console.log('@@@ btcRelayAbi: ', btcRelayAbi)
  console.log('@@@ gFromAccount: ', gFromAccount)


  var verifyTx;
  verifyTx = true;  // if commented, it will call relayTx

var relayAddr = '0x61f836ebad27a6a3cbb5c070ca6b99925eabd9a3';


  var bethAddress = relayAddr;
  var abiToUse = btcRelayAbi;
  var RelayContract = web3.eth.contract(abiToUse);
  var contract = RelayContract.at(bethAddress);
  console.log('@@@@ contract: ', contract)

  // block300K tx1
  // var tx1300K = '7301b595279ece985f0c415e420e425451fcf7f684fcce087ba14d10ffec1121';

  var transHex = $('#transHex').val();
  // TODO check if transHex is prefixed with 0x
  var txHash = new BigNumber('0x' + transHex);

  var txBlockHash = new BigNumber('0x'+gBlockHashOfTx);

  // web3.js wants 0x prepended
  var merkleSibling = gMerkleProof.sibling.map(function(sib) {
    return '0x' + sib;
    // return new BigNumber('0x' + sib);
  });

  if (verifyTx) {
    console.log('@@@@ going to call() verifyTx')
    var startTime = Date.now();

    var objParam = {from:web3.eth.coinbase, gas: 3000000};
    var res = contract.verifyTx.call(txHash, gMerkleProof.txIndex, merkleSibling, txBlockHash, objParam);


    var endTime = Date.now();
    var durationSec = (endTime - startTime) / 1000;
    console.log('@@@@ verifyTx res: ', res, ' duration: ', durationSec)
    document.getElementById('result').innerText = res.toString(10) + "    " + durationSec+ "secs";
    return;
  }

  document.getElementById('result').innerText = 'Ethereum transaction is in progress...'
}


function getTxInfo() {
  var txid = $('#transHex').val();
  console.log('@@@ txid: ', txid);

  var urlJsonTx = "https://btc.blockr.io/api/v1/tx/raw/" + txid;
  $.getJSON(urlJsonTx, function(data) {
      console.log('@@@ data: ', data)

      gRawTx = data.data.tx.hex;
      $('#txHexText').val(gRawTx);

      var blockNum = data.data.tx.blockhash; // blockr does not easily provide block height
      $('#txBlockNum').text('n/a for blockr.io');
      // $('#txBlockNum').text(blockNum);

      var blockInfoUrl = "http://btc.blockr.io/api/v1/block/raw/"+blockNum;
      $.getJSON(blockInfoUrl, function(res) {
          console.log('@@@ res: ', res)

          gBlockHashOfTx = res.data.hash;
          $('#txBlockHash').text(gBlockHashOfTx)

          var txIndex;
          for (var key in res.data.tx) {
            if (res.data.tx[key] == txid) {
              txIndex = key;
              break;
            }
          }

          // var txIndex = Object.keys(res.data.tx).indexOf(txid);
          console.log('@@@@ txIndex: ', txIndex)

          gMerkleProof = btcproof.getProof(res.data.tx, txIndex);
          console.log('@@@ mp: ', gMerkleProof)
          $('#mProof').val(JSON.stringify(gMerkleProof));
      })

  })
}


$(function() {
  // tx[1] of block 360276
  $('#transHex').val('be44a9201e8016b1772e7331f3c3c8a4820060307df4603033dc5350a01ac279');

  $('#btn-get-tx').click(getTxInfo);

  $('#relayAddr').text(gRelayAddr);
});



</script>

</head>

<body>

  <div class="container">
    <div class="logo">
      <img src="./images/ethereum-logo-small.png"/>
    </div>

    <p class="lead">btcrelay at <span id="relayAddr"></span> has
      <span id="exchBal"></span> ether.
    </p>

    <p>This is a sample of calling the verifyTx method on the btcrelay contract
    </p>

    <form class="form">
      <div class="form-group">
        <label for="transHex">Bitcoin Transaction Hash</label>
        <input type="text" class="form-control" id="transHex" size="64" maxlength="64"></input>
      </div>
      <button type="button" class="btn btn-default" id="btn-get-tx">Lookup</button>
    </form>

    <form>
      <div class="form-group">
        <label for="txHexText">Raw Transaction</label>
        <textarea readonly class="form-control" name="textarea" id="txHexText" rows="6" cols="50"></textarea>

        <label for="mProof">Merkle Proof</label>
        <textarea readonly class="form-control" name="textarea" id="mProof" rows="6" cols="50"></textarea>

        <label class="col-md-1 control-label">Block Number</label>
        <div class="col-md-1">
          <p class="form-control-static" id="txBlockNum">0</p>
        </div>

        <label class="col-md-1 control-label">Block Hash</label>
        <div class="col-md-9">
          <p class="form-control-static" id="txBlockHash">0</p>
        </div>
      </div>
      <br><br>
      <button type="button" class="btn btn-default" onclick="callContract();">Call verifyTx</button>
    </form>


    <div id="result"></div>

    <div class="footer-logo">
      <img src="./images/ETH_DEV_LOGO_LARGE.svg"/>
    </div>
  </div>

</body>

</html>
