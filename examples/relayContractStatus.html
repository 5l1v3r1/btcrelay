<!DOCTYPE html>
<html lang="en">
<head>
  <title>Ethereum: Bitcoin Relay Contract Status</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/dapp.css">
  <script src="./js/jquery-2.1.3.min.js"></script>
  <script src="./js/bootstrap.min.js"></script>

  <script src="./js/btcRelayAbi.js"></script>

  <script src="./js/bignumber.js"></script>
  <script src="./js/web3.min.js"></script>

  <script>
  var web3 = require('web3');
  web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));

  $(function() {
    var relayAddr = web3.eth.namereg.addr('btcrelay');

    $('#relayAddr').text(relayAddr);

    var RelayContract = web3.eth.contract(btcRelayAbi);  // see ./js/btcRelayAbi.js
    var contract = RelayContract.at(relayAddr);

    var height = contract.getLastBlockHeight.call();
    $('#latestBlockHeight').text(height);

    var headHash = contract.getBlockchainHead.call();
    $('#latestBlockHash').text(formatHash(headHash));

    var headScore = contract.getCumulativeDifficulty.call();
    $('#latestBlockScore').text(web3.toBigNumber(headScore).toString(10));

    updateBCI();
    updateBlockr();
    updateNodeBlockNum();
  });

  function updateBCI() {
    // 2 calls needed since https://blockchain.info/latestblock is missing CORS
    $.getJSON('https://blockchain.info/q/getblockcount?cors=true', function(data) {
      $('#bciBlockHeight').text(data);
    });

    // https://github.com/blockchain/api-v1-client-python/issues/17
    // $.getJSON('https://blockchain.info/q/latesthash?cors=true', function(data) {
    //   $('#bciBlockHash').text(data);
    // });
  }

  function updateBlockr() {
    $.getJSON('http://btc.blockr.io/api/v1/block/info/last', function(data) {
      $('#blockrBlockHeight').text(data.data.nb);
    });
  }

  function updateNodeBlockNum() {
    $('#nodeBlockNum').text(web3.eth.blockNumber);
  }

  function formatHash(bnHash) {
    var hash = bnHash.toString(16);
    return Array(64 - hash.length + 1).join('0') + hash;
  }

  </script>
</head>

<body>
  <div class="container">
    <div class="logo">
      <img src="./images/ethereum-logo-small.png"/>
    </div>

    <div class="jumbotron">
      <h2>Ethereum Bitcoin Relay Contract Status</h2>
      <h3>btcrelay: <strong id="relayAddr"></strong></h3>
      <h3>Latest Block#: <strong id="latestBlockHeight"></strong></h3>
      <h3>Latest Block Hash: <strong id="latestBlockHash"></strong></h3>
      <h3>Latest Block Cumulative Difficulty: <strong id="latestBlockScore"></strong></h3>
      <br>
      <h3>Your Ethereum node doesn't seem to be fully synced: <span id=nodeBlockNum></span>.  Check <a href="https://stats.ethdev.com" target="_">stats</a>
        for the latest blocks.
      </h3>
    </div>

    <h3><a href="https://blockchain.info" target="_">blockchain.info</a> Latest Block#: <strong id="bciBlockHeight"></strong></h3>
    <h3><a href="https://btc.blockr.io" target="_">btc.blockr.io</a> Latest Block#: <strong id="blockrBlockHeight"></strong></h3>
    <!-- <h3>blockchain.info Latest Block Hash: <strong id="bciBlockHash"></strong></h3> -->

    <div class="footer-logo">
      <img src="./images/ETH_DEV_LOGO_LARGE.svg"/>
    </div>
  </div>
</body>

</html>
